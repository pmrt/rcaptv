version: "3.9"

x-environment: &global_environment
  POSTGRES_USER: ${POSTGRES_USER}
  POSTGRES_PORT: ${POSTGRES_PORT}
  POSTGRES_DB_NAME: ${POSTGRES_DB_NAME}
  POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
  TRACKER_POSTGRES_USER: ${TRACKER_POSTGRES_USER}
  TRACKER_POSTGRES_PASSWORD: ${TRACKER_POSTGRES_PASSWORD}
  RCAPTV_POSTGRES_USER: ${RCAPTV_POSTGRES_USER}
  RCAPTV_POSTGRES_PASSWORD: ${RCAPTV_POSTGRES_PASSWORD}

  BALANCER_SALT: ${BALANCER_SALT}

  POSTGRES_HOST: pg_db
  POSTGRES_MAX_IDLE_CONNS: ${POSTGRES_MAX_IDLE_CONNS}
  POSTGRES_MAX_OPEN_CONNS: ${POSTGRES_MAX_OPEN_CONNS}
  POSTGRES_CONN_MAX_LIFETIME_MINUTES: ${POSTGRES_CONN_MAX_LIFETIME_MINUTES}
  POSTGRES_CONN_TIMEOUT_SECONDS: ${POSTGRES_CONN_TIMEOUT_SECONDS}
  POSTGRES_MIG_VERSION: ${POSTGRES_MIG_VERSION}
  POSTGRES_MIG_PATH: ${POSTGRES_MIG_PATH}
  SKIP_MIGRATIONS: ${SKIP_MIGRATIONS}
  DEBUG: ${DEBUG}

  HELIX_CLIENT_ID: ${HELIX_CLIENT_ID}
  HELIX_CLIENT_SECRET: ${HELIX_CLIENT_SECRET}
  WEBHOOK_SECRET: ${WEBHOOK_SECRET}

  COOKIE_SECRET: ${COOKIE_SECRET}
  API_DOMAIN: ${API_DOMAIN}
  DOMAIN: ${DOMAIN}
  BASE_URL: ${BASE_URL}
  HEALTH_ENDPOINT: ${HEALTH_ENDPOINT}
  LOGIN_ENDPOINT: ${LOGIN_ENDPOINT}
  LOGOUT_ENDPOINT: ${LOGOUT_ENDPOINT}
  API_ENDPOINT: ${API_ENDPOINT}
  API_HELIX_ENDPOINT: ${API_HELIX_ENDPOINT}
  API_VALIDATE_ENDPOINT: ${API_VALIDATE_ENDPOINT}
  API_VODS_ENDPOINT: ${API_VODS_ENDPOINT}
  API_CLIPS_ENDPOINT: ${API_CLIPS_ENDPOINT}
  AUTH_ENDPOINT: ${AUTH_ENDPOINT}
  AUTH_REDIRECT_ENDPOINT: ${AUTH_REDIRECT_ENDPOINT}
  TWITCH_API_URL: ${TWITCH_API_URL}
  EVENTSUB_ENDPOINT: ${EVENTSUB_ENDPOINT}
  WEBSERVER_PORT: ${WEBSERVER_PORT}
  API_PORT: ${API_PORT}
  API_RATE_LIMIT_MAX_CONNS: ${API_RATE_LIMIT_MAX_CONNS}
  API_RATE_LIMIT_EXP_SECONDS: ${API_RATE_LIMIT_EXP_SECONDS}
  WEBSERVER_RATE_LIMIT_MAX_CONNS: ${WEBSERVER_RATE_LIMIT_MAX_CONNS}
  WEBSERVER_RATE_LIMIT_EXP_SECONDS: ${WEBSERVER_RATE_LIMIT_EXP_SECONDS}
  CLIPS_MAX_PERIOD_DIFF_HOURS: ${CLIPS_MAX_PERIOD_DIFF_HOURS}
  ESTIMATED_ACTIVE_USERS: ${ESTIMATED_ACTIVE_USERS}

  TOKEN_COLLECTOR_INTERVAL_HOURS: ${TOKEN_COLLECTOR_INTERVAL_HOURS}
  TRACKING_CYCLE_MINUTES: ${TRACKING_CYCLE_MINUTES}
  CLIP_VIEW_THRESHOLD: ${CLIP_VIEW_THRESHOLD}
  CLIP_VIEW_WINDOW_SIZE: ${CLIP_VIEW_WINDOW_SIZE}
  CLIP_TRACKING_WINDOW_HOURS: ${CLIP_TRACKING_WINDOW_HOURS}
  CLIP_TRACKING_MAX_DEEP_LEVEL: ${CLIP_TRACKING_MAX_DEEP_LEVEL}
  WEBSERVER_INDEX_PATH: ${WEBSERVER_INDEX_PATH}
  WEBSERVER_STATIC_DIR: ${WEBSERVER_STATIC_DIR}
  WEBSERVER_VIEWS_DIR: ${WEBSERVER_VIEWS_DIR}


services:
  pg_db:
    image: postgres
    restart: always
    ports:
      - "${POSTGRES_PORT}:${POSTGRES_PORT}"
    volumes:
      - ./.volumes/postgres:/var/lib/postgresql/data
    networks:
      - net1
    environment:
      <<: *global_environment

  rcaptv:
    depends_on:
      - pg_db
    build:
      context: .
      dockerfile: docker/api.Dockerfile
    networks:
      - net1
    environment:
      <<: *global_environment
      POSTGRES_HOST: pg_db
    ports:
      - "3021:${API_PORT}"

  tracker:
    depends_on:
      - pg_db
    build:
      context: .
      dockerfile: docker/tracker.Dockerfile
    networks:
      - net1
    environment:
      <<: *global_environment
      POSTGRES_HOST: pg_db

networks:
  net1:
